# OpenBLAS Regression Tests

## Building OpenBLAS

To build OpenBLAS, use one of the Dockerfiles provided in this repo. The Dockerfiles tell Podman to build OpenBLAS using rpmbuild with specific parameters. You can either (1.) use `Dockerfile.autoconfig` to autoconfigure the OpenBLAS build, or (2.) use `Dockerfile` and modify the environment variables at the top.

### RHEL 8

#### Autoconfigure the Build

`Dockerfile.autoconfig` looks at your CPU microarchitecture to determine if you need to use "HASWELL", "SKYLAKEX", "NEHALEM", "SANDYBRIDGE", etc. as your target CPU. (Default is "CORE2".) It also checks for AVX\* instructions on your machine. While OpenBLAS does have scripts to autodetect the CPU type, sometimes it cannot do it properly and will ask you to input a target CPU, causing the automated build to fail.

To build,

```
$ podman build -f Dockerfiles/Dockerfile.autoconfig --tag=rhel8_openblas_autoconfig_build
```

#### Manually Configure the Build

If you're familiar with how OpenBLAS works or you want to manually tweak parameters,

  - `AVX_CFLAGS`: Choose one or more from { `NO_AVX`, `NO_AVX2`, `NO_AVX512` }. Set an AVX flag equal to 0 if you want to use it; otherwise, 1 to disable it.
  - `TARGET_CPU`: Choose one from { `HASWELL`, `SKYLAKEX`, `NEHALEM`, `SANDYBRIDGE` }. Other, older CPUs are supported, but you'll have to look at the OpenBLAS `get_arch.c` code here: https://github.com/xianyi/OpenBLAS/blob/develop/getarch.c

To build,

```
$ podman build -f Dockerfiles/Dockerfile --tag=rhel8_openblas_custom_build
```

### RHEL 7

The RHEL 7 Dockerfile, `Dockerfile.rhel7`, does everything the `Dockerfile` and `Dockerfile.autoconfig` do, except on RHEL 7. However, it downloads the OpenBLAS source rpm via yum, rather than acquiring the source rpm from a website.

To build,

```
$ podman build -f Dockerfiles/Dockerfile.rhel7 --tag=rhel7_openblas_custom_build
```

## How to Build the Tests

First, make sure you have built and/or installed OpenBLAS. Once you have done so, you're ready to compile. To compile the SGEMM test,

```
$ sh compile_gemm.sh -g sgemm -I <path/to/openblas/include/files> -L <path/to/openblas/libs> -n <path/to/threaded/lib>
```

e.g.,

```
$ sh compile_gemm.sh -g dgemm -I /usr/include/openblas -L /usr/lib64 -n openblasp
```

For dgemm, do the same thing, except pass in `dgemm` as a value for the `-g` flag.

```
$ sh compile_gemm.sh -g dgemm -I <path/to/openblas/include/files> -L <path/to/openblas/libs> -n <path/to/threaded/lib>
```

For help on how to use the `compile_gemm.sh` command line tool, run `sh compile_gemm.sh -h`.


## How to Run the Tests

For both `dgemm_test` and `sgemm_test` (which are autogenerated by the `compile_gemm.sh` script), the inputs are: (1.) number of threads, (2.) number of times to repeat the computation to get an average performance time across N computations, (3.) JSON document filename to save results to, and (4.) true/false as to whether you want to print out the JSON results after running the tests.

e.g.,

```
$ dgemm_test.sh 24 10 "dgemm_results.json" true
```

This will execute a dgemm test on 24 threads, repeating the same computation 10 times. The results will be saved to `dgemm_results.json` and printed out to the command line.
